<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Hotspots per Twine (Harlowe)</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #imageEditor {
            flex: 2;
            min-width: 400px;
            position: relative; 
            cursor: crosshair;
            display: flex;
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            padding: 0; 
            height: auto; 
            min-height: 400px;
            border: 1px dashed #ccc; 
            box-sizing: border-box; 
        }
        #imageDisplay {
            max-width: 100%;
            height: auto; 
            display: block; 
            margin-bottom: 15px; 
        }
        #drawingInstructions {
            text-align: center;
            margin-top: 15px;
            color: #555;
            width: 100%; 
            padding: 0 20px; 
            box-sizing: border-box;
        }
        #imageEditor > div:first-of-type { 
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%; 
        }
        
        .hotspot-area {
            position: absolute;
            border: 2px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.2);
            cursor: move; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-sizing: border-box;
        }
        .hotspot-delete-button-visual {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background-color: red;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px; 
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10; 
            border: 1px solid white; 
            display: flex; 
            align-items: center;
            justify-content: center;
        }

        #hotspotListPanel { 
            flex: 1;
            min-width: 300px;
        }
        .hotspot-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .hotspot-item label {
            font-weight: bold;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .hotspot-item input, .hotspot-item select, .hotspot-item textarea { 
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 16px); 
            box-sizing: border-box;
        }
        .hotspot-item button.delete-config-button { 
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-end; 
            margin-top: 10px;
        }
        .hotspot-item button.delete-config-button:hover {
            background-color: #c82333;
        }
        .form-group {
            margin-bottom: 15px;
            width: 100%; 
            box-sizing: border-box;
            padding: 0 20px; 
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="file"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #eee;
            width: calc(100% - 16px); 
            box-sizing: border-box;
        }
        .copy-feedback {
            color: green;
            margin-left: 10px;
            font-weight: bold;
            display: inline-block;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .copy-feedback.show {
            opacity: 1;
        }
        button#copyCodeButton, button#loadCodeButton { 
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }
        button#copyCodeButton:hover, button#loadCodeButton:hover {
            background-color: #0056b3;
        }
        textarea { 
            width: 100%;
            height: 80px; 
            margin-top: 5px; 
            padding: 8px; 
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap; 
            overflow-y: auto; 
            box-sizing: border-box;
        }
        #outputCode { 
             height: 250px;
             white-space: pre; 
             width: calc(100% - 20px); 
             margin-left: auto;
             margin-right: auto;
             font-size: 0.9em;
        }
        #instructions {
            background-color: #e9ecef;
            padding: 15px;
            border-left: 5px solid #007bff;
            margin-top: 20px;
            border-radius: 4px;
        }
        #instructions p {
            margin-bottom: 5px;
        }
        #instructions code {
            background-color: #fff;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        pre {
            background-color: #e9e9e9;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .hidden-field {
            display: none;
        }
        #editorImageInfoDisplay {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 1em;
            text-align: center;
            display: none;
            max-width: 80%;
            box-sizing: border-box;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.4; 
            overflow: hidden; 
        }
    </style>
</head>
<body>
    <h1>Editor de Hotspots per Imatges (Twine/Harlowe)</h1>

    <div class="container">
        <div class="panel" id="imageEditor">
            <h2>1. Carrega la teva Imatge</h2>
            <div class="form-group">
                <label for="imageUpload">Selecciona una imatge:</label>
                <input type="file" id="imageUpload" accept="image/*">
            </div>
            <div> 
                <img id="imageDisplay" src="" alt="Carrega una imatge" style="display: none;">
                <div id="editorImageInfoDisplay"></div> 
            </div>
            
            <p id="drawingInstructions">
                Un cop carregada la imatge, fes clic i arrossega per dibuixar un hotspot.<br>
                Fes clic <em>sobre</em> un hotspot ja creat i arrossega per moure'l.<br>
                Fes clic a la 'X' vermella sobre un hotspot per eliminar-lo.
            </p>
        </div>

        <div class="panel" id="hotspotListPanel">
            <h2>2. Configura els Hotspots</h2>
            <div id="hotspotsContainer">
                <p>No hi ha hotspots creats.</p>
            </div>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <h2>3. Codi per a Twine (Harlowe)</h2>
        <p>Copia el següent codi i enganxa'l al teu passatge de Twine.</p>
        <textarea id="outputCode"></textarea> <button id="copyCodeButton">Copiar Codi</button><span id="copyFeedback" class="copy-feedback">Codi copiat!</span>
        <button id="loadCodeButton" style="margin-left: 10px;">Carregar Codi a l'Editor</button>
    </div>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const imageDisplay = document.getElementById('imageDisplay');
        const imageEditor = document.getElementById('imageEditor');
        const hotspotsContainerEl = document.getElementById('hotspotsContainer'); 
        const outputCode = document.getElementById('outputCode');
        const copyCodeButton = document.getElementById('copyCodeButton');
        const drawingInstructions = document.getElementById('drawingInstructions');
        const editorImageInfoDisplay = document.getElementById('editorImageInfoDisplay');
        const copyFeedback = document.getElementById('copyFeedback');
        const loadCodeButton = document.getElementById('loadCodeButton'); // Nou element per al botó de càrrega

        let isDrawing = false;
        let isDragging = false;
        let activeHotspotElement = null;
        let dragOffsetX, dragOffsetY;
        let startX, startY; 
        let currentRect = null;
        let hotspots = [];
        let hotspotIdCounter = 0;

        // Funció per amagar el missatge de feedback
        function hideCopyFeedback() {
            copyFeedback.classList.remove('show');
        }

        imageUpload.addEventListener('change', (e) => {
            hideCopyFeedback(); // Amaga el feedback al canviar la imatge
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageDisplay.src = event.target.result;
                    imageDisplay.style.display = 'block';
                    drawingInstructions.style.display = 'none'; 
                    editorImageInfoDisplay.style.display = 'none';
           
                    imageDisplay.onload = () => {
                        const extraSpace = 80; 
                        imageEditor.style.minHeight = imageDisplay.offsetHeight + extraSpace + 'px';
                        imageEditor.style.height = imageDisplay.offsetHeight + extraSpace + 'px';
                        hotspots = []; 
                        renderHotspots();
                        generateTwineCode();
                    };
                    imageDisplay.onerror = () => {
                        alert("Error al carregar la imatge.");
                        imageDisplay.src = ''; imageDisplay.style.display = 'none';
                        drawingInstructions.style.display = 'block';
                        editorImageInfoDisplay.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                imageDisplay.src = '';
                imageDisplay.style.display = 'none';
                drawingInstructions.style.display = 'block';
                editorImageInfoDisplay.style.display = 'none';
                imageEditor.style.height = 'auto'; imageEditor.style.minHeight = '400px'; 
                hotspots = []; renderHotspots(); generateTwineCode();
            }
        });

        imageEditor.addEventListener('mousedown', (e) => {
            hideCopyFeedback(); // Amaga el feedback al començar a dibuixar/arrossegar
            if (imageDisplay.style.display === 'none' || !imageDisplay.src) return;
            if (e.target.classList.contains('hotspot-delete-button-visual')) return; 
            if (e.target.classList.contains('hotspot-area')) {
                isDragging = true; activeHotspotElement = e.target;
                const hotspotRect = activeHotspotElement.getBoundingClientRect();
                dragOffsetX = e.clientX - hotspotRect.left; dragOffsetY = e.clientY - hotspotRect.top;
                activeHotspotElement.style.cursor = 'grabbing'; e.stopPropagation(); 
            } else if (imageEditor.contains(e.target) && (e.target === imageDisplay || e.target === imageEditor || e.target.parentElement === imageEditor || e.target.parentElement.parentElement === imageEditor ) ) { 
 
                isDrawing = true; const imageRect = imageDisplay.getBoundingClientRect();
                startX = e.clientX - imageRect.left; startY = e.clientY - imageRect.top;    
                currentRect = document.createElement('div'); currentRect.classList.add('hotspot-area');
                const editorRect = imageEditor.getBoundingClientRect();
                currentRect.style.left = `${e.clientX - editorRect.left}px`;
                currentRect.style.top = `${e.clientY - editorRect.top}px`;
                currentRect.style.width = '0px'; currentRect.style.height = '0px';
                currentRect.style.cursor = 'crosshair'; imageEditor.appendChild(currentRect);
                imageEditor.style.cursor = 'grabbing';
            }
        });
        document.addEventListener('mousemove', (e) => {
            if (isDrawing && currentRect) {
                const imageRect = imageDisplay.getBoundingClientRect(), editorRect = imageEditor.getBoundingClientRect();
                let currentMouseEventX_onImage = e.clientX - imageRect.left, currentMouseEventY_onImage = e.clientY - imageRect.top;
                let rLeft = Math.min(startX, currentMouseEventX_onImage), rTop = Math.min(startY, currentMouseEventY_onImage),
         
                    rRight = Math.max(startX, currentMouseEventX_onImage), rBottom = Math.max(startY, currentMouseEventY_onImage);
                rLeft = Math.max(0, rLeft); rTop = Math.max(0, rTop);
                rRight = Math.min(imageRect.width, rRight); rBottom = Math.min(imageRect.height, rBottom);
                let rWidth = rRight - rLeft, rHeight = rBottom - rTop;
          
                if (rWidth < 0) rWidth = 0; if (rHeight < 0) rHeight = 0;
                currentRect.style.left = `${(imageRect.left - editorRect.left) + rLeft}px`;
                currentRect.style.top = `${(imageRect.top - editorRect.top) + rTop}px`;
                currentRect.style.width = `${rWidth}px`; currentRect.style.height = `${rHeight}px`;
            } else if (isDragging && activeHotspotElement) { 
                const imageRect = imageDisplay.getBoundingClientRect(), editorRect = imageEditor.getBoundingClientRect();
                let newLeftInEditor = e.clientX - editorRect.left - dragOffsetX, newTopInEditor = e.clientY - editorRect.top - dragOffsetY;
                const hotspotWidth = activeHotspotElement.offsetWidth, hotspotHeight = activeHotspotElement.offsetHeight,
                      imageLeftInEditor = imageRect.left - editorRect.left, imageTopInEditor = imageRect.top - editorRect.top,
                      imageRightInEditor = imageLeftInEditor + imageRect.width, imageBottomInEditor = imageTopInEditor + imageRect.height;
                newLeftInEditor = Math.max(imageLeftInEditor, Math.min(newLeftInEditor, imageRightInEditor - hotspotWidth));
                newTopInEditor = Math.max(imageTopInEditor, Math.min(newTopInEditor, imageBottomInEditor - hotspotHeight));
                activeHotspotElement.style.left = `${newLeftInEditor}px`; activeHotspotElement.style.top = `${newTopInEditor}px`;
            }
        });

        document.addEventListener('mouseup', (e) => { 
            if (isDrawing && currentRect) {
                isDrawing = false; 
                const natW = imageDisplay.naturalWidth, natH = imageDisplay.naturalHeight,
                      dispW = imageDisplay.offsetWidth, dispH = imageDisplay.offsetHeight; 
  
                const hotspotRectVis = currentRect.getBoundingClientRect(), imageRectVis = imageDisplay.getBoundingClientRect();
                let l_disp = hotspotRectVis.left - imageRectVis.left, t_disp = hotspotRectVis.top - imageRectVis.top,
                    w_disp = hotspotRectVis.width, h_disp = hotspotRectVis.height;
                currentRect.remove(); currentRect = null; 
         
                if (w_disp >= 5 && h_disp >= 5 && dispW && dispH) {
                    const sX = natW / dispW, sY = natH / dispH;
                    const fL = l_disp * sX, fT = t_disp * sY, fW = w_disp * sX, fH = h_disp * sY;
           
                    const coords = [Math.round(fL),Math.round(fT),Math.round(fL+fW),Math.round(fT+fH)].join(',');
                    hotspotIdCounter++;
                    hotspots.push({ id: hotspotIdCounter, coords: coords, name: `Hotspot ${hotspotIdCounter}`,
                        type: 'passage', value: '', titleText: '', sound: '', infoText: '', 
                        titleTextSetter: '', soundSetter: '', infoTextSetter: '' });
                }
                renderHotspots(); generateTwineCode();
            } else if (isDragging && activeHotspotElement) {
                isDragging = false;
                const hotspotId = parseInt(activeHotspotElement.dataset.hotspotId), hotspot = hotspots.find(h => h.id === hotspotId);
                if (hotspot) {
                    const natW = imageDisplay.naturalWidth, natH = imageDisplay.naturalHeight,
                          dispW = imageDisplay.offsetWidth, dispH = imageDisplay.offsetHeight;
                    if (dispW && dispH) {
                        const hotspotRectVis = activeHotspotElement.getBoundingClientRect(), imageRectVis = imageDisplay.getBoundingClientRect();
                        const l_disp = hotspotRectVis.left-imageRectVis.left, t_disp = hotspotRectVis.top-imageRectVis.top,
                              w_disp = hotspotRectVis.width, h_disp = hotspotRectVis.height;
                        const sX = natW/dispW, sY = natH/dispH;
                        const fL=l_disp*sX, fT=t_disp*sY, fW=w_disp*sX, fH=h_disp*sY;
                        hotspot.coords = [Math.round(fL),Math.round(fT),Math.round(fL+fW),Math.round(fT+fH)].join(',');
                        generateTwineCode();
                    }
                }
            }
            imageEditor.style.cursor = 'crosshair';
            if(activeHotspotElement && !isDragging) activeHotspotElement.style.cursor = 'move';
            if(!isDragging) activeHotspotElement = null; 
        });
        function renderHotspots() {
            hotspotsContainerEl.innerHTML = '';
            document.querySelectorAll('#imageEditor .hotspot-area').forEach(el => { if (el !== currentRect) el.remove(); });
            if (hotspots.length === 0) hotspotsContainerEl.innerHTML = '<p>No hi ha hotspots creats.</p>';
            
            // Només intentar visualitzar hotspots si hi ha una imatge carregada i amb dimensions vàlides
            if (imageDisplay.src && imageDisplay.naturalWidth && imageDisplay.naturalHeight) {
                const dispW = imageDisplay.offsetWidth, dispH = imageDisplay.offsetHeight,
                      natW = imageDisplay.naturalWidth, natH = imageDisplay.naturalHeight;

                const imgRectGlob = imageDisplay.getBoundingClientRect(), editorRectGlob = imageEditor.getBoundingClientRect(),
                      offsetXinEd = imgRectGlob.left - editorRectGlob.left, offsetYinEd = imgRectGlob.top - editorRectGlob.top,
                      scaleX = dispW / natW, scaleY = dispH / natH;
                hotspots.forEach(hotspot => {
                    const coordsArr = hotspot.coords.split(',').map(Number),
                          visRect = document.createElement('div');
                    visRect.classList.add('hotspot-area'); visRect.dataset.hotspotId = hotspot.id;
                    visRect.style.left = `${(coordsArr[0] * scaleX) + offsetXinEd}px`;
                    visRect.style.top = `${(coordsArr[1] * scaleY) + offsetYinEd}px`;
                    visRect.style.width = `${(coordsArr[2] - coordsArr[0]) * scaleX}px`;
                    visRect.style.height = `${(coordsArr[3] - coordsArr[1]) * scaleY}px`;
                    
                    visRect.addEventListener('mouseenter', () => {
                        let info = '';
                        if (hotspot.type === 'passage' && hotspot.infoText) info = hotspot.infoText;
                  
                        else if (hotspot.type === 'setter' && hotspot.infoTextSetter) info = hotspot.infoTextSetter;
                        if (info) { editorImageInfoDisplay.innerHTML = info.replace(/\n/g, '<br>');
                        editorImageInfoDisplay.style.display = 'block'; }
                    });
                    visRect.addEventListener('mouseleave', () => { editorImageInfoDisplay.innerHTML = ''; editorImageInfoDisplay.style.display = 'none'; });

                    const delBtn = document.createElement('div');
                    delBtn.classList.add('hotspot-delete-button-visual'); delBtn.textContent = 'X';
                    delBtn.title = "Eliminar aquest hotspot";
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); removeHotspot(hotspot.id); });
                    visRect.appendChild(delBtn); imageEditor.appendChild(visRect);
                });
            }

            hotspots.forEach(hotspot => {
                const item = document.createElement('div'); item.classList.add('hotspot-item'); item.dataset.hotspotId = hotspot.id;
                item.innerHTML = `
                    <label>Nom Hotspot:</label><input type="text" data-field="name" value="${hotspot.name || ''}" placeholder="Ex: Porta">
                 
                    <label>Acció:</label><select data-field="type"><option value="passage" ${hotspot.type==='passage'?'selected':''}>Anar Passatge</option><option value="setter" ${hotspot.type==='setter'?'selected':''}>Canviar Variable</option></select>
                    <label class="value-label">${hotspot.type==='passage'?'Passatge destí:':'Variable i Valor:'}</label><input type="text" data-field="value" value="${hotspot.value || ''}" placeholder="${hotspot.type==='passage'?'Ex: Bosc':'Ex: $punts to 100'}">
                    <div class="passage-specific-fields ${hotspot.type==='passage'?'':'hidden-field'}"><label>Tooltip:</label><input type="text" data-field="titleText" value="${hotspot.titleText || ''}"><label>So (Ex: 'clic.mp3'):</label><input type="text" data-field="sound" value="${hotspot.sound || ''}"><label>Info Textual (sota imatge):</label><textarea data-field="infoText">${hotspot.infoText || ''}</textarea></div>
                    <div class="setter-specific-fields ${hotspot.type==='setter'?'':'hidden-field'}"><label>Tooltip (Setter):</label><input type="text" data-field="titleTextSetter" value="${hotspot.titleTextSetter || ''}"><label>So (Setter):</label><input type="text" data-field="soundSetter" value="${hotspot.soundSetter || ''}"><label>Info Textual (Setter):</label><textarea data-field="infoTextSetter">${hotspot.infoTextSetter || ''}</textarea></div>
                    <button class="delete-config-button">Eliminar</button>`;
                hotspotsContainerEl.appendChild(item);
                const pFields = item.querySelector('.passage-specific-fields'), sFields = item.querySelector('.setter-specific-fields'),
                      vLabel = item.querySelector('.value-label'), vInput = item.querySelector('input[data-field="value"]');
   
                const toggle = type => {
                    pFields.classList.toggle('hidden-field', type !== 'passage'); sFields.classList.toggle('hidden-field', type !== 'setter');
                    vLabel.textContent = type==='passage'?'Passatge destí:':'Variable i Valor:'; vInput.placeholder = type==='passage'?'Ex: Bosc':'Ex: $punts to 100';
                };
       
                toggle(hotspot.type);
                item.querySelector('input[data-field="name"]').addEventListener('input', e => { hotspot.name = e.target.value; generateTwineCode(); hideCopyFeedback(); }); 
                item.querySelector('select[data-field="type"]').addEventListener('change', e => { hotspot.type = e.target.value; toggle(hotspot.type); generateTwineCode(); hideCopyFeedback(); });
                ['value','titleText','sound','infoText','titleTextSetter','soundSetter','infoTextSetter'].forEach(f => {
                    const elType = (f === 'infoText' || f === 'infoTextSetter') ? 'textarea' : 'input';
                    item.querySelector(`${elType}[data-field="${f}"]`).addEventListener('input', e => { hotspot[f] = e.target.value; generateTwineCode(); hideCopyFeedback(); }); 
             
                });
                item.querySelector('.delete-config-button').addEventListener('click', () => { removeHotspot(hotspot.id); hideCopyFeedback(); });
            });
        }

        function removeHotspot(id) {
            hotspots = hotspots.filter(h => h.id !== id);
            renderHotspots(); generateTwineCode();
        }

        function generateTwineCode() {
            if (!imageDisplay.src || !imageDisplay.naturalWidth || !imageUpload.files || imageUpload.files.length === 0) { 
                outputCode.value = "<p>Carrega una imatge per generar el codi.</p>";
                return;
            }
            const originalFileName = imageUpload.files[0].name;
            let twineCode = `<div class="twine-image-wrapper" style="min-width:${imageDisplay.naturalWidth}px;">\n`;
            twineCode += `    <img src="imatges/${originalFileName.replace(/"/g, '&quot;')}" usemap="#hotspotmap" alt="Imatge amb hotspots">\n`; 
            twineCode += '    <map name="hotspotmap">\n';
            hotspots.forEach(hotspot => {
                const coords = hotspot.coords;
  
                const altText = (hotspot.name || `Hotspot ${hotspot.id}`).replace(/"/g, '&quot;');
                let areaTag = `        <area shape="rect" coords="${coords}" alt="${altText}" class="hotspot-item"`; 
                if (hotspot.type === 'passage') {
                    if (hotspot.value) areaTag += ` data-passage="${hotspot.value.replace(/"/g, '&quot;')}"`;
                    if (hotspot.titleText) areaTag += ` title="${hotspot.titleText.replace(/"/g, '&quot;')}"`;
                    if (hotspot.sound) areaTag += ` data-sound="${hotspot.sound.replace(/"/g, '&quot;')}"`;
                    if (hotspot.infoText) areaTag += ` data_info="${hotspot.infoText.replace(/"/g, '&quot;').replace(/\n/g, '<br>')}"`;
                } else if (hotspot.type === 'setter') {
                    if (hotspot.value) areaTag += ` data-setter="${hotspot.value.replace(/"/g, '&quot;')}"`;
                    if (hotspot.titleTextSetter) areaTag += ` title="${hotspot.titleTextSetter.replace(/"/g, '&quot;')}"`;
                    if (hotspot.soundSetter) areaTag += ` data-sound="${hotspot.soundSetter.replace(/"/g, '&quot;')}"`;
                    if (hotspot.infoTextSetter) areaTag += ` data_info="${hotspot.infoTextSetter.replace(/"/g, '&quot;').replace(/\n/g, '<br>')}"`;
                }
                areaTag += '>\n';
                twineCode += areaTag;
            });
            twineCode += '    </map>\n';
            twineCode += `    <div id="${window.TWINE_IMAGE_INFO_DISPLAY_ID || 'twineImageInfoDisplay'}" style="display: none;"></div>\n`;
            twineCode += '</div>\n\n';
            // --- INICI DELS ENLLAÇOS HARLOWE OCULTS ---
            twineCode += '<span id="Ocult" style="display:none;">\n';
            hotspots.forEach(hotspot => {
                if (hotspot.type === 'passage' && hotspot.value) {
                    const passageNameForLink = hotspot.value.replace(/"/g, '\\"');
                
                    const harloweLink = `    (link: "${passageNameForLink}")[(goto: "${passageNameForLink}")]`;
                    twineCode += `${harloweLink}\n`; 
                }
            });
            twineCode += '</span>';

            outputCode.value = twineCode;
        }

        copyCodeButton.addEventListener('click', () => {
            outputCode.select();
            document.execCommand('copy');
            copyFeedback.classList.add('show'); 
        });

        // Nou event listener per al botó de càrrega
        loadCodeButton.addEventListener('click', () => {
            hideCopyFeedback();
            const codeToParse = outputCode.value;
            if (codeToParse.trim() === "") {
                alert("El camp de codi està buit. Enganxa el codi HTML/Harlowe per carregar.");
                return;
            }
            parseTwineCode(codeToParse);
        });

        function parseTwineCode(code) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(code, 'text/html');

            const imgElement = doc.querySelector('.twine-image-wrapper img');
            if (!imgElement) {
                alert("No s'ha trobat cap etiqueta <img> amb usemap dins de .twine-image-wrapper.");
                return;
            }

            const imgSrc = imgElement.getAttribute('src');
            if (!imgSrc) {
                alert("La imatge no té un atribut 'src'.");
                return;
            }

            // Actualitzar el camp de selecció de fitxer per mostrar el nom del fitxer
            // Això només actualitza el nom visible, no carrega el fitxer realment.
            const fileName = imgSrc.split('/').pop();
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(new File([], fileName)); // Crea un fitxer "buit" amb el nom
            imageUpload.files = dataTransfer.files;

            // No donem cap avís. Simplement intentem treballar amb la imatge actual.
            // Si no hi ha imatge o les dimensions no són vàlides, renderHotspots ja ho gestiona.
            
            // Si la imatge actualment visible a l'editor no coincideix amb la del codi,
            // els hotspots es visualitzaran de forma incorrecta.
            // No hi haurà cap alerta per informar d'aquesta possible discrepància.
            if (imageDisplay.src && imageDisplay.naturalWidth && imageDisplay.naturalHeight) {
                // Si ja hi ha una imatge, podem ajustar l'editor a la seva mida.
                const extraSpace = 80; 
                imageEditor.style.minHeight = imageDisplay.offsetHeight + extraSpace + 'px';
                imageEditor.style.height = imageDisplay.offsetHeight + extraSpace + 'px';
            } else {
                // Si no hi ha imatge carregada, assegurem-nos que l'editor torni al seu estat inicial
                imageDisplay.style.display = 'none';
                drawingInstructions.style.display = 'block';
                editorImageInfoDisplay.style.display = 'none';
                imageEditor.style.height = 'auto';
                imageEditor.style.minHeight = '400px';
            }

            hotspots = []; // Netejar els hotspots existents abans de carregar
            let maxHotspotId = 0;

            const areaElements = doc.querySelectorAll('map[name="hotspotmap"] area');
            areaElements.forEach(area => {
                const coords = area.getAttribute('coords');
                const altText = area.getAttribute('alt');
                const dataPassage = area.getAttribute('data-passage');
                const dataSetter = area.getAttribute('data-setter');
                const title = area.getAttribute('title');
                const dataSound = area.getAttribute('data-sound');
                const dataInfo = area.getAttribute('data_info');

                hotspotIdCounter++; // Incrementar per a cada nou hotspot
                maxHotspotId = Math.max(maxHotspotId, hotspotIdCounter); // Mantenir el màxim ID

                let newHotspot = {
                    id: hotspotIdCounter,
                    coords: coords,
                    name: altText || `Hotspot ${hotspotIdCounter}`,
                    type: 'passage', // Default
                    value: '',
                    titleText: '',
                    sound: '',
                    infoText: '',
                    titleTextSetter: '',
                    soundSetter: '',
                    infoTextSetter: ''
                };

                if (dataPassage) {
                    newHotspot.type = 'passage';
                    newHotspot.value = dataPassage;
                    newHotspot.titleText = title || '';
                    newHotspot.sound = dataSound || '';
                    newHotspot.infoText = dataInfo ? dataInfo.replace(/<br>/g, '\n') : '';
                } else if (dataSetter) {
                    newHotspot.type = 'setter';
                    newHotspot.value = dataSetter;
                    newHotspot.titleTextSetter = title || '';
                    newHotspot.soundSetter = dataSound || '';
                    newHotspot.infoTextSetter = dataInfo ? dataInfo.replace(/<br>/g, '\n') : '';
                }
                hotspots.push(newHotspot);
            });
            hotspotIdCounter = maxHotspotId; // Reinicialitzar el comptador d'ID amb el valor màxim trobat

            renderHotspots();
            generateTwineCode();
        }
        
        // Initialize display
        renderHotspots();
        generateTwineCode();
        // Optional: Recalculate hotspot positions on window resize
        window.addEventListener('resize', renderHotspots);
    </script>
</body>
</html>
